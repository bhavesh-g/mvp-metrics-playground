<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLM Metric Playground</title>
    <style>
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #1a1a1a;
            --bg-card: #242424;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --border-color: #404040;
            --accent: #ffffff;
            --font-main: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --font-mono: "SF Mono", Monaco, "Cascadia Code", "Roboto Mono", Consolas, "Courier New", monospace;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        html, body {
            height: 100%;
            font-family: var(--font-main);
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        body {
            display: flex;
            flex-direction: column;
        }

        /* Header */
        header {
            border-bottom: 1px solid var(--border-color);
            padding: 1.2rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-secondary);
            flex-wrap: wrap;
            gap: 1rem;
        }

        h1 { 
            font-size: 1.3rem; 
            font-weight: 700; 
            letter-spacing: -0.5px; 
        }
        
        .config-bar {
            display: flex;
            gap: 0.8rem;
            align-items: center;
        }

        #api-url {
            width: 280px;
            padding: 0.6rem 0.8rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-family: var(--font-main);
            font-size: 0.85rem;
            background: var(--bg-card);
            color: var(--text-primary);
        }

        /* Layout */
        .container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Sidebar */
        aside {
            width: 320px;
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            background: var(--bg-secondary);
            overflow: hidden;
        }

        .sidebar-header {
            padding: 1rem 1.2rem;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--text-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-actions {
            display: flex;
            gap: 0.5rem;
        }

        #metric-list {
            list-style: none;
            overflow-y: auto;
            flex: 1;
        }

        .metric-item {
            padding: 1rem 1.2rem;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            transition: background 0.15s;
            position: relative;
        }

        .metric-item:hover { 
            background: var(--bg-card); 
        }

        .metric-item.active { 
            background: var(--accent); 
            color: var(--bg-primary);
        }

        .metric-item .name {
            font-weight: 600;
            margin-bottom: 0.3rem;
            font-size: 0.9rem;
        }

        .metric-item .desc {
            font-size: 0.75rem;
            opacity: 0.6;
            line-height: 1.3;
        }

        .metric-item.active .desc {
            opacity: 0.7;
        }

        .metric-item .actions {
            position: absolute;
            top: 0.8rem;
            right: 0.8rem;
            display: none;
            gap: 0.3rem;
        }

        .metric-item:hover .actions {
            display: flex;
        }

        .metric-item.active .actions {
            display: flex;
        }

        /* Main Content */
        main {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        /* Tab Navigation */
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-secondary);
            padding: 0 2rem;
        }

        .tab {
            padding: 1rem 1.5rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            font-weight: 600;
            font-size: 0.85rem;
            transition: all 0.2s;
            color: var(--text-secondary);
        }

        .tab:hover {
            color: var(--text-primary);
        }

        .tab.active {
            color: var(--text-primary);
            border-bottom-color: var(--accent);
        }

        /* Tab Content */
        .tab-content {
            display: none;
            padding: 2rem;
            flex: 1;
            overflow-y: auto;
        }

        .tab-content.active {
            display: block;
        }

        /* Form Elements */
        input[type="text"], 
        input[type="url"], 
        textarea, 
        select {
            width: 100%;
            padding: 0.7rem 0.8rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-family: var(--font-main);
            font-size: 0.9rem;
            background: var(--bg-card);
            color: var(--text-primary);
            transition: border-color 0.2s;
        }

        textarea {
            font-family: var(--font-mono);
            resize: vertical;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--accent);
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        /* Buttons */
        button, .btn {
            background: var(--accent);
            color: var(--bg-primary);
            border: none;
            padding: 0.7rem 1.2rem;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        button:hover { 
            opacity: 0.85;
        }

        button:disabled { 
            opacity: 0.4; 
            cursor: not-allowed;
        }
        
        button.secondary {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        button.secondary:hover { 
            background: var(--bg-card);
            border-color: var(--accent);
        }

        button.small {
            padding: 0.4rem 0.8rem;
            font-size: 0.7rem;
        }

        button.danger {
            background: #dc2626;
        }

        /* Card */
        .card {
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 2rem;
            margin-bottom: 2rem;
            background: var(--bg-card);
        }

        .card h2, .card h3 {
            margin-bottom: 1.5rem;
            font-size: 1.2rem;
        }

        /* Results */
        pre {
            background: var(--bg-secondary);
            padding: 1.2rem;
            border-radius: 4px;
            overflow-x: auto;
            font-family: var(--font-mono);
            font-size: 0.8rem;
            border: 1px solid var(--border-color);
            line-height: 1.6;
            color: var(--text-primary);
        }

        .status-badge {
            display: inline-block;
            padding: 0.3rem 0.7rem;
            border-radius: 3px;
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            background: var(--accent);
            color: var(--bg-primary);
        }

        /* Grid */
        .grid-2 { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 1.5rem;
        }

        /* Loader */
        .loader {
            border: 2px solid var(--border-color);
            border-top: 2px solid var(--accent);
            border-radius: 50%;
            width: 14px;
            height: 14px;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin { 
            to { transform: rotate(360deg); } 
        }

        .hidden { display: none !important; }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #606060;
        }

        /* JSON Editor Hint */
        .json-hint {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border-color);
        }

        @media (max-width: 1024px) {
            aside { width: 280px; }
            .tab-content { padding: 1.5rem; }
        }

        @media (max-width: 768px) {
            .container { flex-direction: column; }
            aside { 
                width: 100%; 
                max-height: 200px; 
                border-right: none; 
                border-bottom: 1px solid var(--border-color); 
            }
            header { flex-direction: column; align-items: flex-start; }
            .config-bar, #api-url { width: 100%; }
            .grid-2 { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<header>
    <h1>âš¡ LLM Metric Playground</h1>
    <div class="config-bar">
        <input type="url" id="api-url" placeholder="API Base URL" value="https://custom-metric-playground.vercel.app">
        <button class="secondary" id="refresh-btn">Refresh</button>
    </div>
</header>

<div class="container">
    <!-- Sidebar -->
    <aside>
        <div class="sidebar-header">
            <span>Metrics</span>
            <div class="sidebar-actions">
                <button class="secondary small" id="create-metric-btn">+ New</button>
            </div>
        </div>
        <ul id="metric-list">
            <li style="padding:1.2rem; color: var(--text-secondary); text-align: center;">Click Refresh</li>
        </ul>
    </aside>

    <!-- Main Content -->
    <main>
        <!-- Tabs -->
        <div class="tabs">
            <div class="tab active" data-tab="evaluate">Evaluate</div>
            <div class="tab" data-tab="create">Create Metric</div>
            <div class="tab" data-tab="bulk">Bulk Operations</div>
        </div>

        <!-- Tab: Evaluate -->
        <div class="tab-content active" id="tab-evaluate">
            <div id="empty-state" class="empty-state">
                <p style="font-size: 1.1rem;">ðŸ“Š Select a metric to evaluate</p>
            </div>

            <div id="workspace" class="hidden">
                <div class="card">
                    <h2 id="active-metric-name">Metric</h2>
                    <p id="active-metric-desc" style="color: var(--text-secondary); margin-bottom: 1rem;"></p>
                    <span class="status-badge" id="active-metric-id">ID</span>

                    <form id="eval-form" style="margin-top: 2rem;">
                        <div id="dynamic-inputs"></div>

                        <div class="grid-2">
                            <div class="form-group">
                                <label for="provider">Provider</label>
                                <select id="provider" name="provider">
                                    <option value="perplexity">Perplexity</option>
                                    <option value="openai">OpenAI</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="model">Model</label>
                                <select id="model" name="model">
                                    <option value="sonar-pro">sonar-pro</option>
                                    <option value="gpt-4">gpt-4</option>
                                    <option value="gpt-4o">gpt-4o</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-actions">
                            <button type="submit" id="run-btn">
                                <span id="run-text">Evaluate</span>
                                <span id="loading-indicator" class="loader hidden"></span>
                            </button>
                        </div>
                    </form>
                </div>

                <div id="results-area" class="hidden">
                    <div class="card">
                        <h3>Results</h3>
                        <pre id="json-output"></pre>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Create Metric -->
        <div class="tab-content" id="tab-create">
            <div class="card">
                <h2>Create New Metric</h2>
                <form id="create-form">
                    <div class="form-group">
                        <label for="new-name">Metric Name (slug)</label>
                        <input type="text" id="new-name" required placeholder="e.g., jira-quality">
                    </div>

                    <div class="form-group">
                        <label for="new-desc">Description</label>
                        <input type="text" id="new-desc" placeholder="Brief description">
                    </div>

                    <div class="form-group">
                        <label for="new-inputs">Input Fields (comma-separated)</label>
                        <input type="text" id="new-inputs" required placeholder="e.g., query, response, context">
                        <div class="json-hint">These will be the dynamic form fields</div>
                    </div>

                    <div class="form-group">
                        <label for="new-prompt">Prompt Template (Jinja2)</label>
                        <textarea id="new-prompt" rows="8" required placeholder="Evaluate this: {{ query }}"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="new-output">Output Schema (JSON)</label>
                        <textarea id="new-output" rows="6" required placeholder='{"score": "number", "reasoning": "string"}'></textarea>
                        <div class="json-hint">Defines expected LLM response structure</div>
                    </div>

                    <div class="form-actions">
                        <button type="reset" class="secondary">Clear</button>
                        <button type="submit">
                            <span id="create-text">Create Metric</span>
                            <span id="create-loading" class="loader hidden"></span>
                        </button>
                    </div>
                </form>
                <div id="create-result" class="hidden" style="margin-top: 2rem;">
                    <pre id="create-output"></pre>
                </div>
            </div>
        </div>

        <!-- Tab: Bulk Operations -->
        <div class="tab-content" id="tab-bulk">
            <div class="card">
                <h2>Bulk Evaluate</h2>
                <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">Upload JSON file or paste test cases</p>
                
                <div class="form-group">
                    <label for="bulk-metric">Select Metric</label>
                    <select id="bulk-metric"></select>
                </div>

                <div class="form-group">
                    <label>Upload File (.json)</label>
                    <input type="file" id="bulk-file" accept=".json">
                </div>

                <div class="form-group">
                    <label>Or Paste JSON Array</label>
                    <textarea id="bulk-json" rows="10" placeholder='[{"query": "test1"}, {"query": "test2"}]'></textarea>
                </div>

                <div class="form-actions">
                    <button id="bulk-eval-btn">
                        <span id="bulk-text">Run Bulk Evaluation</span>
                        <span id="bulk-loading" class="loader hidden"></span>
                    </button>
                </div>

                <div id="bulk-result" class="hidden" style="margin-top: 2rem;">
                    <h3>Bulk Results</h3>
                    <pre id="bulk-output"></pre>
                </div>
            </div>
        </div>
    </main>
</div>

<script>
    // State
    const state = {
        metrics: [],
        activeMetric: null,
        baseUrl: localStorage.getItem('llm_api_url') || 'https://custom-metric-playground.vercel.app'
    };

    // DOM
    const $ = id => document.getElementById(id);
    const $$ = sel => document.querySelectorAll(sel);

    // Init
    $('api-url').value = state.baseUrl;
    
    // Event Listeners
    $('refresh-btn').addEventListener('click', fetchMetrics);
    $('create-metric-btn').addEventListener('click', () => switchTab('create'));
    $('eval-form').addEventListener('submit', handleEvaluation);
    $('create-form').addEventListener('submit', handleCreateMetric);
    $('bulk-eval-btn').addEventListener('click', handleBulkEval);

    // Tab switching
    $$('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
            const tabName = tab.dataset.tab;
            switchTab(tabName);
        });
    });

    function switchTab(tabName) {
        $$('.tab').forEach(t => t.classList.remove('active'));
        $$('.tab-content').forEach(tc => tc.classList.remove('active'));
        
        document.querySelector(`.tab[data-tab="${tabName}"]`).classList.add('active');
        $(`tab-${tabName}`).classList.add('active');
    }

    // Auto-fetch
    if (state.baseUrl) fetchMetrics();

    // Fetch Metrics
    async function fetchMetrics() {
        $('refresh-btn').disabled = true;
        $('refresh-btn').textContent = 'Loading...';
        $('metric-list').innerHTML = '<li style="padding:1.2rem; color: var(--text-secondary);">Fetching...</li>';

        try {
            state.baseUrl = $('api-url').value.replace(/\/$/, '');
            localStorage.setItem('llm_api_url', state.baseUrl);

            const res = await fetch(`${state.baseUrl}/v1/metrics/?limit=100`);
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            
            state.metrics = await res.json();
            renderMetricList();
            populateBulkMetricSelect();
        } catch (err) {
            console.error(err);
            $('metric-list').innerHTML = `<li style="padding:1.2rem; color:#dc2626;">${err.message}</li>`;
        } finally {
            $('refresh-btn').disabled = false;
            $('refresh-btn').textContent = 'Refresh';
        }
    }

    // Render Metric List
    function renderMetricList() {
        $('metric-list').innerHTML = '';
        
        if (state.metrics.length === 0) {
            $('metric-list').innerHTML = '<li style="padding:1.2rem; color: var(--text-secondary);">No metrics</li>';
            return;
        }

        state.metrics.forEach(metric => {
            const li = document.createElement('li');
            li.className = 'metric-item';
            li.innerHTML = `
                <div class="name">${metric.name}</div>
                <div class="desc">${metric.description || 'No description'}</div>
                <div class="actions">
                    <button class="secondary small" onclick="deleteMetric('${metric.name}', event)">Ã—</button>
                </div>
            `;
            
            li.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') return;
                selectMetric(metric, li);
            });
            
            $('metric-list').appendChild(li);
        });
    }

    // Select Metric
    function selectMetric(metric, element) {
        state.activeMetric = metric;

        $$('.metric-item').forEach(el => el.classList.remove('active'));
        element.classList.add('active');

        $('empty-state').classList.add('hidden');
        $('workspace').classList.remove('hidden');
        $('results-area').classList.add('hidden');

        $('active-metric-name').textContent = metric.name;
        $('active-metric-desc').textContent = metric.description || 'No description';
        $('active-metric-id').textContent = metric._id || metric.name;

        generateInputFields(metric.input_fields || []);
        $('eval-form').reset();
        
        switchTab('evaluate');
    }

    // Generate Input Fields
    function generateInputFields(fields) {
        $('dynamic-inputs').innerHTML = '';

        if (!fields || fields.length === 0) {
            $('dynamic-inputs').innerHTML = '<p style="color: var(--text-secondary);">No inputs defined</p>';
            return;
        }

        fields.forEach(field => {
            const div = document.createElement('div');
            div.className = 'form-group';
            
            const label = document.createElement('label');
            label.textContent = fieldLabel(field);
            label.setAttribute('for', `input-${field}`);

            const isTextarea = ['query', 'response', 'content', 'text', 'body', 'context', 'prompt']
                .some(kw => field.toLowerCase().includes(kw));

            const input = isTextarea ? document.createElement('textarea') : document.createElement('input');
            if (isTextarea) input.rows = 4;
            else input.type = 'text';
            
            input.id = `input-${field}`;
            input.name = field;
            input.required = true;
            input.placeholder = `Enter ${fieldLabel(field).toLowerCase()}...`;

            div.appendChild(label);
            div.appendChild(input);
            $('dynamic-inputs').appendChild(div);
        });
    }

    // Handle Evaluation
    async function handleEvaluation(e) {
        e.preventDefault();
        if (!state.activeMetric) return;

        const payload = {
            inputs: {},
            provider: $('provider').value,
            model: $('model').value
        };

        state.activeMetric.input_fields.forEach(field => {
            const val = $(`input-${field}`).value.trim();
            if (!val) {
                alert(`Please fill: ${field}`);
                throw new Error('Validation failed');
            }
            payload.inputs[field] = val;
        });

        setLoading('run', true);
        $('results-area').classList.add('hidden');

        try {
            const res = await fetch(`${state.baseUrl}/v1/metrics/${state.activeMetric.name}/evaluate`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const data = await res.json();
            
            $('results-area').classList.remove('hidden');
            $('json-output').textContent = JSON.stringify(data, null, 2);
            $('json-output').style.color = res.ok ? 'var(--text-primary)' : '#dc2626';

        } catch (err) {
            $('results-area').classList.remove('hidden');
            $('json-output').textContent = `Error: ${err.message}`;
            $('json-output').style.color = '#dc2626';
        } finally {
            setLoading('run', false);
        }
    }

    // Handle Create Metric
    async function handleCreateMetric(e) {
        e.preventDefault();

        const payload = {
            name: $('new-name').value.trim(),
            description: $('new-desc').value.trim() || null,
            input_fields: $('new-inputs').value.split(',').map(s => s.trim()),
            prompt_template: $('new-prompt').value.trim(),
            output_schema: JSON.parse($('new-output').value.trim())
        };

        setLoading('create', true);
        $('create-result').classList.add('hidden');

        try {
            const res = await fetch(`${state.baseUrl}/v1/metrics/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const data = await res.json();
            
            $('create-result').classList.remove('hidden');
            $('create-output').textContent = JSON.stringify(data, null, 2);
            $('create-output').style.color = res.ok ? 'var(--text-primary)' : '#dc2626';

            if (res.ok) {
                alert('Metric created! Refreshing list...');
                fetchMetrics();
                $('create-form').reset();
            }

        } catch (err) {
            $('create-result').classList.remove('hidden');
            $('create-output').textContent = `Error: ${err.message}`;
            $('create-output').style.color = '#dc2626';
        } finally {
            setLoading('create', false);
        }
    }

    // Delete Metric
    async function deleteMetric(name, event) {
        event.stopPropagation();
        if (!confirm(`Delete metric "${name}"?`)) return;

        try {
            const res = await fetch(`${state.baseUrl}/v1/metrics/${name}`, {
                method: 'DELETE'
            });

            if (res.ok) {
                alert('Deleted!');
                fetchMetrics();
            } else {
                alert('Delete failed');
            }
        } catch (err) {
            alert(`Error: ${err.message}`);
        }
    }

    // Populate Bulk Metric Select
    function populateBulkMetricSelect() {
        $('bulk-metric').innerHTML = state.metrics.map(m => 
            `<option value="${m.name}">${m.name}</option>`
        ).join('');
    }

    // Handle Bulk Eval
    async function handleBulkEval() {
        const metricName = $('bulk-metric').value;
        const file = $('bulk-file').files[0];
        const jsonText = $('bulk-json').value.trim();

        if (!file && !jsonText) {
            alert('Provide file or JSON');
            return;
        }

        setLoading('bulk', true);
        $('bulk-result').classList.add('hidden');

        try {
            let res;
            
            if (file) {
                const formData = new FormData();
                formData.append('file', file);
                res = await fetch(`${state.baseUrl}/v1/metrics/${metricName}/evaluate/file`, {
                    method: 'POST',
                    body: formData
                });
            } else {
                const testCases = JSON.parse(jsonText);
                res = await fetch(`${state.baseUrl}/v1/metrics/${metricName}/evaluate/bulk`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ test_cases: testCases })
                });
            }

            const data = await res.json();
            
            $('bulk-result').classList.remove('hidden');
            $('bulk-output').textContent = JSON.stringify(data, null, 2);
            $('bulk-output').style.color = res.ok ? 'var(--text-primary)' : '#dc2626';

        } catch (err) {
            $('bulk-result').classList.remove('hidden');
            $('bulk-output').textContent = `Error: ${err.message}`;
            $('bulk-output').style.color = '#dc2626';
        } finally {
            setLoading('bulk', false);
        }
    }

    // Helpers
    function fieldLabel(field) {
        return field.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
    }

    function setLoading(btn, loading) {
        const indicator = $(`${btn}-loading`);
        const text = $(`${btn}-text`);
        const button = indicator.closest('button');
        
        if (loading) {
            indicator.classList.remove('hidden');
            button.disabled = true;
        } else {
            indicator.classList.add('hidden');
            button.disabled = false;
        }
    }
</script>

</body>
</html>
