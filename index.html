<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LLM Metric Playground - Evaluation Console</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<style>
/* === ORIGINAL CSS UNCHANGED === */
:root {
  --bg-primary:#0a0a0a;--bg-secondary:#1a1a1a;--bg-tertiary:#2a2a2a;
  --border-color:#3a3a3a;--text-primary:#fff;--text-secondary:#b0b0b0;
  --text-muted:#6a6a6a;--accent:#fff;--error:#ff4444;--success:#44ff44
}
body{font-family:Inter,sans-serif;background:var(--bg-primary);color:var(--text-primary)}
.card{background:var(--bg-secondary);border:1px solid var(--border-color)}
.form-control,.form-select{background:var(--bg-tertiary);border:1px solid var(--border-color);color:#fff}
.metric-item{background:var(--bg-tertiary);border:1px solid var(--border-color);padding:1rem;margin-bottom:.75rem}
.metric-actions{display:flex;gap:.5rem}
.json-output{background:var(--bg-tertiary);padding:1rem;font-family:monospace}
</style>
</head>

<body>

<header class="header p-3 border-bottom">
<div class="container">
<h3>LLM Metric Playground</h3>
<p class="text-secondary">Evaluation Engine for Production AI Systems</p>
</div>
</header>

<div class="container py-4">

<div id="alertContainer"></div>

<ul class="nav nav-tabs mb-4">
<li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#metricsTab">Metrics</a></li>
<li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#createTab">Create Metric</a></li>
<li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#evaluateTab">Evaluate</a></li>
</ul>

<div class="tab-content">

<!-- ================= METRICS ================= -->
<div class="tab-pane fade show active" id="metricsTab">
<div id="metricsList"></div>
</div>

<!-- ================= CREATE / EDIT ================= -->
<div class="tab-pane fade" id="createTab">
<div class="card">
<div class="card-body">

<form id="createMetricForm">
<input type="hidden" id="editingMetricId">

<div class="mb-3">
<label class="form-label">Metric Name</label>
<input class="form-control" id="metricName" required>
</div>

<div class="mb-3">
<label class="form-label">Description</label>
<input class="form-control" id="metricDescription">
</div>

<div class="mb-3">
<label class="form-label">Input Fields</label>
<div id="inputFieldsContainer"></div>
<button type="button" class="btn btn-sm btn-outline-secondary mt-1" onclick="addInputField()">+</button>
</div>

<div class="mb-3">
<label class="form-label">Prompt Template</label>
<textarea class="form-control" id="promptTemplate" rows="6" required></textarea>
</div>

<div class="mb-3">
<label class="form-label">Output Schema</label>
<div id="outputSchemaContainer"></div>
<button type="button" class="btn btn-sm btn-outline-secondary mt-1" onclick="addOutputField()">+</button>
</div>

<button class="btn btn-primary w-100">Save Metric</button>
</form>

</div>
</div>
</div>

<!-- ================= EVALUATE ================= -->
<div class="tab-pane fade" id="evaluateTab">
<div class="card">
<div class="card-body">

<form id="evaluateForm">

<select class="form-select mb-2" id="evalMetricSelect" onchange="updateEvalInputs()" required></select>

<select class="form-select mb-2" id="evalProvider">
<option value="openai">openai</option>
<option value="perplexity">perplexity</option>
</select>

<input class="form-control mb-2" id="evalModel" value="sonar-pro">

<div id="evalInputsContainer"></div>

<button class="btn btn-primary w-100">Evaluate</button>
</form>

<div id="evalResultContainer" class="mt-3" style="display:none">
<pre class="json-output" id="evalResult"></pre>
</div>

</div>
</div>
</div>

</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
const API_BASE = 'https://custom-metric-playground.vercel.app';
let metricsCache = [];
let editingMetricId = null;

/* ---------- helpers ---------- */
function showAlert(msg,type='info'){
const d=document.createElement('div');
d.className=`alert alert-${type}`;
d.textContent=msg;
alertContainer.appendChild(d);
setTimeout(()=>d.remove(),4000);
}

async function api(endpoint,opt={}){
const r=await fetch(API_BASE+endpoint,{
headers:{'Content-Type':'application/json'},
...opt
});
if(!r.ok) throw new Error(await r.text());
return r.json();
}

/* ---------- load metrics ---------- */
async function loadMetrics(){
metricsCache = await api('/v1/metrics/?limit=100');
metricsList.innerHTML = metricsCache.map(m=>`
<div class="metric-item">
<div class="metric-name">${m.name}</div>
<div class="metric-meta">
inputs: ${m.input_fields.join(', ')} |
outputs: ${Object.keys(m.output_schema).join(', ')}
</div>
<div class="metric-actions">
<button class="btn btn-sm btn-outline-secondary" onclick="editMetric('${m._id}')">edit</button>
<button class="btn btn-sm btn-danger" onclick="deleteMetric('${m._id}','${m.name}')">delete</button>
</div>
</div>
`).join('');

evalMetricSelect.innerHTML =
'<option value="">Choose a metric...</option>' +
metricsCache.map(m=>`<option value="${m._id}">${m.name}</option>`).join('');
}

/* ---------- dynamic fields ---------- */
function addInputField(val=''){
inputFieldsContainer.insertAdjacentHTML('beforeend',`
<div class="field-array-item input-row d-flex gap-2 mb-1">
<input class="form-control input-field" value="${val}" required>
<button type="button" class="btn btn-outline-secondary" onclick="this.parentElement.remove()">−</button>
</div>
`);
}

function addOutputField(key='',type='number'){
outputSchemaContainer.insertAdjacentHTML('beforeend',`
<div class="field-array-item output-row d-flex gap-2 mb-1">
<input class="form-control output-field-key" value="${key}" required>
<select class="form-select output-field-type">
<option ${type==='number'?'selected':''}>number</option>
<option ${type==='string'?'selected':''}>string</option>
<option ${type==='boolean'?'selected':''}>boolean</option>
</select>
<button type="button" class="btn btn-outline-secondary" onclick="this.parentElement.remove()">−</button>
</div>
`);
}

/* ---------- create / update ---------- */
createMetricForm.addEventListener('submit',async e=>{
e.preventDefault();

const input_fields=[...document.querySelectorAll('.input-row .input-field')].map(i=>i.value.trim());

const output_schema={};
document.querySelectorAll('.output-row').forEach(r=>{
output_schema[
r.querySelector('.output-field-key').value.trim()
]={ type:r.querySelector('.output-field-type').value };
});

const payload={
name:metricName.value.trim(),
description:metricDescription.value.trim(),
prompt_template:promptTemplate.value.trim(),
input_fields,
output_schema
};

if(editingMetricId){
await api(`/v1/metrics/${editingMetricId}`,{method:'PATCH',body:JSON.stringify(payload)});
showAlert('metric updated','success');
}else{
await api('/v1/metrics/',{method:'POST',body:JSON.stringify(payload)});
showAlert('metric created','success');
}

editingMetricId=null;
createMetricForm.reset();
inputFieldsContainer.innerHTML='';
outputSchemaContainer.innerHTML='';
addInputField();
addOutputField();
loadMetrics();
});

/* ---------- edit ---------- */
function editMetric(id){
const m=metricsCache.find(x=>x._id===id);
editingMetricId=id;
metricName.value=m.name;
metricDescription.value=m.description||'';
promptTemplate.value=m.prompt_template;

inputFieldsContainer.innerHTML='';
m.input_fields.forEach(addInputField);

outputSchemaContainer.innerHTML='';
Object.entries(m.output_schema).forEach(([k,v])=>addOutputField(k,v.type));

document.querySelector('[href="#createTab"]').click();
}

/* ---------- delete ---------- */
async function deleteMetric(id,name){
if(!confirm(`delete ${name}?`))return;
await api(`/v1/metrics/${id}`,{method:'DELETE'});
showAlert('metric deleted','success');
loadMetrics();
}

/* ---------- evaluate ---------- */
function updateEvalInputs(){
const m=metricsCache.find(x=>x._id===evalMetricSelect.value);
evalInputsContainer.innerHTML = m.input_fields.map(f=>`
<div class="mb-2">
<label class="form-label">${f}</label>
<textarea class="form-control eval-input" data-f="${f}" required></textarea>
</div>
`).join('');
}

evaluateForm.addEventListener('submit',async e=>{
e.preventDefault();
const inputs={};
document.querySelectorAll('.eval-input').forEach(i=>inputs[i.dataset.f]=i.value);

const res = await api(`/v1/metrics/${evalMetricSelect.value}/evaluate`,{
method:'POST',
body:JSON.stringify({
inputs,
provider:evalProvider.value,
model:evalModel.value
})
});

evalResultContainer.style.display='block';
evalResult.textContent=JSON.stringify(res,null,2);
});

/* ---------- init ---------- */
addInputField();
addOutputField();
loadMetrics();
</script>

</body>
</html>
