<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
<meta charset="UTF-8">
<title>LLM Metric Playground</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>

<body class="bg-dark text-light">

<div class="container py-4">
<h3>LLM Metric Playground</h3>

<div id="alertContainer"></div>

<ul class="nav nav-tabs mb-3">
<li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#metrics">Metrics</a></li>
<li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#create">Create / Edit</a></li>
<li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#evaluate">Evaluate</a></li>
</ul>

<div class="tab-content">

<!-- METRICS -->
<div class="tab-pane fade show active" id="metrics">
<div id="metricsList"></div>
</div>

<!-- CREATE / EDIT -->
<div class="tab-pane fade" id="create">
<form id="metricForm">
<input type="hidden" id="editingMetricId">

<div class="mb-2">
<label>Name</label>
<input class="form-control" id="metricName" required>
</div>

<div class="mb-2">
<label>Description</label>
<input class="form-control" id="metricDescription">
</div>

<div class="mb-2">
<label>Input fields</label>
<div id="inputFieldsContainer"></div>
<button type="button" class="btn btn-sm btn-secondary mt-1" onclick="addInputField()">+</button>
</div>

<div class="mb-2">
<label>Prompt</label>
<textarea class="form-control" id="promptTemplate" rows="5" required></textarea>
</div>

<div class="mb-2">
<label>Output schema</label>
<div id="outputSchemaContainer"></div>
<button type="button" class="btn btn-sm btn-secondary mt-1" onclick="addOutputField()">+</button>
</div>

<button class="btn btn-primary mt-3" id="saveMetricBtn">Save Metric</button>
</form>
</div>

<!-- EVALUATE -->
<div class="tab-pane fade" id="evaluate">
<form id="evaluateForm">

<select id="evalMetricSelect" class="form-select mb-2" onchange="updateEvalInputs()" required></select>

<select id="evalProvider" class="form-select mb-2">
<option value="openai">openai</option>
<option value="perplexity">perplexity</option>
</select>

<input id="evalModel" class="form-control mb-2" value="sonar-pro">

<div id="evalInputsContainer"></div>

<button class="btn btn-primary mt-2">Evaluate</button>
</form>

<pre id="evalResult" class="mt-3"></pre>
</div>

</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
const API = 'https://custom-metric-playground.vercel.app';
let metrics = [];

const alertBox = (msg,type='info')=>{
const d=document.createElement('div');
d.className=`alert alert-${type}`;
d.textContent=msg;
document.getElementById('alertContainer').appendChild(d);
setTimeout(()=>d.remove(),4000);
};

const api = (url,opt={})=>fetch(API+url,{
headers:{'Content-Type':'application/json'},
...opt
}).then(r=>r.ok?r.json():r.text().then(t=>Promise.reject(t)));

const loadMetrics = async ()=>{
metrics = await api('/v1/metrics/?limit=100');
document.getElementById('metricsList').innerHTML = metrics.map(m=>`
<div class="border p-2 mb-2">
<b>${m.name}</b><br>
<button class="btn btn-sm btn-secondary" onclick="editMetric('${m._id}')">edit</button>
<button class="btn btn-sm btn-danger" onclick="deleteMetric('${m._id}')">delete</button>
</div>
`).join('');

document.getElementById('evalMetricSelect').innerHTML =
'<option value="">select</option>' +
metrics.map(m=>`<option value="${m._id}">${m.name}</option>`).join('');
};

const addInputField = (v='')=>{
document.getElementById('inputFieldsContainer').insertAdjacentHTML('beforeend',
`<input class="form-control mb-1 input-field" value="${v}">`);
};

const addOutputField = (k='',t='number')=>{
document.getElementById('outputSchemaContainer').insertAdjacentHTML('beforeend',
`<div class="d-flex mb-1">
<input class="form-control me-1 output-key" value="${k}">
<select class="form-select output-type">
<option ${t==='number'?'selected':''}>number</option>
<option ${t==='string'?'selected':''}>string</option>
<option ${t==='boolean'?'selected':''}>boolean</option>
</select>
</div>`);
};

document.getElementById('metricForm').onsubmit = async e=>{
e.preventDefault();

const output_schema = {};
document.querySelectorAll('.output-key').forEach((k,i)=>{
output_schema[k.value]={ type: document.querySelectorAll('.output-type')[i].value };
});

const payload = {
name: metricName.value,
description: metricDescription.value,
prompt_template: promptTemplate.value,
input_fields: [...document.querySelectorAll('.input-field')].map(i=>i.value),
output_schema
};

const id = editingMetricId.value;
if(id){
await api(`/v1/metrics/${id}`,{method:'PATCH',body:JSON.stringify(payload)});
alertBox('metric updated','success');
}else{
await api('/v1/metrics/',{method:'POST',body:JSON.stringify(payload)});
alertBox('metric created','success');
}

e.target.reset();
editingMetricId.value='';
loadMetrics();
};

const editMetric = id=>{
const m = metrics.find(x=>x._id===id);
editingMetricId.value=id;
metricName.value=m.name;
metricDescription.value=m.description||'';
promptTemplate.value=m.prompt_template;

inputFieldsContainer.innerHTML='';
m.input_fields.forEach(addInputField);

outputSchemaContainer.innerHTML='';
Object.entries(m.output_schema).forEach(([k,v])=>addOutputField(k,v.type));

bootstrap.Tab.getOrCreateInstance(document.querySelector('[href="#create"]')).show();
};

const deleteMetric = async id=>{
await api(`/v1/metrics/${id}`,{method:'DELETE'});
alertBox('deleted','success');
loadMetrics();
};

const updateEvalInputs = ()=>{
const id = evalMetricSelect.value;
const m = metrics.find(x=>x._id===id);
evalInputsContainer.innerHTML = m.input_fields.map(f=>
`<textarea class="form-control mb-1 eval-input" data-f="${f}" placeholder="${f}"></textarea>`
).join('');
};

document.getElementById('evaluateForm').onsubmit = async e=>{
e.preventDefault();
const inputs={};
document.querySelectorAll('.eval-input').forEach(i=>inputs[i.dataset.f]=i.value);
const res = await api(`/v1/metrics/${evalMetricSelect.value}/evaluate`,{
method:'POST',
body:JSON.stringify({inputs,provider:evalProvider.value,model:evalModel.value})
});
evalResult.textContent = JSON.stringify(res,null,2);
};

loadMetrics();
</script>
</body>
</html>
